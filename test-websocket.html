<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¯é£è¯­éŸ³è¯†åˆ«APIæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 3px; margin: 10px 0; font-family: monospace; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>ğŸ¤ è®¯é£è¯­éŸ³è¯†åˆ«APIæµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>ğŸ”§ APIé…ç½®</h3>
        <p><strong>APPID:</strong> a696bc26</p>
        <p><strong>API_SECRET:</strong> ZDQxMGYzNmQ2ZTg4NWNjOTY2MjhiZjI3</p>
        <p><strong>API_KEY:</strong> 761d772b70b55f9225c5e55b89c58963</p>
    </div>

    <div class="test-section">
        <h3>ğŸ”— è¿æ¥æµ‹è¯•</h3>
        <button id="testConnection">æµ‹è¯•WebSocketè¿æ¥</button>
        <button id="testConfig">æµ‹è¯•é…ç½®å‘é€</button>
        <button id="testAudio">æµ‹è¯•éŸ³é¢‘æ•°æ®å‘é€</button>
        <button id="disconnect">æ–­å¼€è¿æ¥</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
        <div id="status" class="info">ç­‰å¾…æµ‹è¯•...</div>
        <div id="logs" class="log"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        let websocket = null;
        let isConnected = false;

        // ç”Ÿæˆç­¾å
        function generateSignature() {
            const date = new Date().toUTCString();
            const signatureString = `host: ise-api.xfyun.cn\ndate: ${date}\nGET /v2/open-ise HTTP/1.1`;
            
            const signature = CryptoJS.HmacSHA256(signatureString, 'ZDQxMGYzNmQ2ZTg4NWNjOTY2MjhiZjI3');
            const signatureB64 = CryptoJS.enc.Base64.stringify(signature);
            
            const authorization = `api_key="761d772b70b55f9225c5e55b89c58963", algorithm="hmac-sha256", headers="host date request-line", signature="${signatureB64}"`;
            
            const authParams = {
                authorization: btoa(authorization),
                date: date,
                host: 'ise-api.xfyun.cn'
            };

            const queryString = Object.entries(authParams)
                .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                .join('&');

            return `wss://ise-api.xfyun.cn/v2/open-ise?${queryString}`;
        }

        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        // æµ‹è¯•WebSocketè¿æ¥
        document.getElementById('testConnection').addEventListener('click', function() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                log('âŒ WebSocketå·²è¿æ¥ï¼Œè¯·å…ˆæ–­å¼€', 'error');
                return;
            }

            try {
                const url = generateSignature();
                log('ğŸ”— æ­£åœ¨è¿æ¥: ' + url.substring(0, 100) + '...', 'info');
                updateStatus('æ­£åœ¨è¿æ¥...', 'info');

                websocket = new WebSocket(url);
                
                websocket.onopen = function() {
                    isConnected = true;
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('WebSocketå·²è¿æ¥', 'success');
                    document.getElementById('testConfig').disabled = false;
                    document.getElementById('testAudio').disabled = false;
                };

                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data, null, 2), 'info');
                    } catch (e) {
                        log('ğŸ“¥ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ' + event.data, 'info');
                    }
                };

                websocket.onerror = function(error) {
                    log('âŒ WebSocketé”™è¯¯: ' + error, 'error');
                    updateStatus('è¿æ¥é”™è¯¯', 'error');
                };

                websocket.onclose = function(event) {
                    isConnected = false;
                    log('ğŸ”Œ WebSocketè¿æ¥å…³é—­: ' + event.code + ' - ' + event.reason, 'info');
                    updateStatus('è¿æ¥å·²å…³é—­', 'info');
                    document.getElementById('testConfig').disabled = true;
                    document.getElementById('testAudio').disabled = true;
                };

            } catch (error) {
                log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
                updateStatus('è¿æ¥å¤±è´¥', 'error');
            }
        });

        // æµ‹è¯•é…ç½®å‘é€
        document.getElementById('testConfig').addEventListener('click', function() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('âŒ WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const configData = {
                common: {
                    app_id: 'a696bc26'
                },
                business: {
                    sub: "ise",
                    ent: "cn_vip",
                    category: "read_sentence",
                    cmd: "ssb",
                    text: "\uFEFFç´…é¯‰é­šèˆ‡ç¶ é¯‰é­šèˆ‡é©¢",
                    tte: "utf-8",
                    ttp_skip: true,
                    aue: "raw",
                    auf: "audio/L16;rate=16000",
                    aus: 1
                },
                data: {
                    status: 0,
                    data: "",
                    data_type: 1
                }
            };

            try {
                websocket.send(JSON.stringify(configData));
                log('ğŸ“¤ é…ç½®å·²å‘é€: ' + JSON.stringify(configData, null, 2), 'success');
                updateStatus('é…ç½®å‘é€æˆåŠŸ', 'success');
            } catch (error) {
                log('âŒ é…ç½®å‘é€å¤±è´¥: ' + error.message, 'error');
                updateStatus('é…ç½®å‘é€å¤±è´¥', 'error');
            }
        });

        // æµ‹è¯•éŸ³é¢‘æ•°æ®å‘é€
        document.getElementById('testAudio').addEventListener('click', function() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('âŒ WebSocketæœªè¿æ¥', 'error');
                return;
            }

            // æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®ï¼ˆç©ºæ•°æ®ç”¨äºæµ‹è¯•ï¼‰
            const audioMessage = {
                business: {
                    aue: "raw",
                    cmd: "auw",
                    aus: 4
                },
                data: {
                    status: 2,
                    data: "",
                    data_type: 1
                }
            };

            try {
                websocket.send(JSON.stringify(audioMessage));
                log('ğŸ“¤ éŸ³é¢‘æ•°æ®å·²å‘é€: ' + JSON.stringify(audioMessage, null, 2), 'success');
                updateStatus('éŸ³é¢‘æ•°æ®å‘é€æˆåŠŸ', 'success');
            } catch (error) {
                log('âŒ éŸ³é¢‘æ•°æ®å‘é€å¤±è´¥: ' + error.message, 'error');
                updateStatus('éŸ³é¢‘æ•°æ®å‘é€å¤±è´¥', 'error');
            }
        });

        // æ–­å¼€è¿æ¥
        document.getElementById('disconnect').addEventListener('click', function() {
            if (websocket) {
                websocket.close();
                log('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('ğŸ“± æ‚¨çš„APIé…ç½®: APPID=a696bc26', 'info');
            log('ğŸ”‘ è¯·ç‚¹å‡»"æµ‹è¯•WebSocketè¿æ¥"å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>
